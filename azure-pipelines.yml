parameters:
  - name: sendgridEnvironments
    type: object
    default:
    - environment: nonprod
      rg: mgmt-state-store-nonprod-rg
      storage_account: dtsmgmtstatestorenonprod
      container: nonprod

    - environment: prod
      rg: mgmt-state-store-prod-rg
      storage_account: dtsmgmtstatestoreprod
      container: prod

variables:
  - name: isMain
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/master')]
  - name: location
    value: uksouth    
  - name: terraformVersion
    value: 0.14.8
  - name: serviceConnection
    value: dts-management-{{ environment.environment }}-intsvc


trigger:
  - master

pool:
  name: Azure Pipelines
  vmImage: 'ubuntu-latest'


stages:
  - ${{ each environment in parameters.sendgridEnvironments }}:
    - stage: ${{ environment.environment }}
      jobs:
        - job: TestAndPlan
          steps:     
          - task: TerraformInstaller@0
            displayName: Terraform install
            inputs:
              terraformVersion: ${{ variables.terraformVersion }}

          - task: TerraformCLI@0
            displayName: Terraform initialize
            inputs:
              command: init
              workingDirectory: $(System.DefaultWorkingDirectory)/terraform
              backendType: azurerm
              ensurebackend: true
              backendServiceArm: $(serviceConnection)
              backendAzureRmResourceGroupName: ${{ environment.rg }}
              backendAzureRmResourceGroupLocation: ${{ variables.location }}
              backendAzureRmStorageAccountName: ${{ environment.storage_account }}
              backendAzureRmStorageAccountSku: Standard_ZRS
              backendAzureRmContainerName: ${{ environment.container }}
              backendAzureRmKey: SendGrid-${{ environment.environment }}/terraform.tfstate

          - task: TerraformCLI@0
            displayName: Terraform validate
            inputs:
              command: validate
              workingDirectory: $(System.DefaultWorkingDirectory)/terraform

          - task: TerraformCLI@0
            displayName: Terraform plan
            inputs:
              command: plan
              workingDirectory: $(System.DefaultWorkingDirectory)/terraform
              environmentServiceName: $(serviceConnection)
              commandOptions: -var-file=../config/${{ environment.environment }}.tfvars -var environment=${{ environment.environment }}


          - task: TerraformCLI@0
            displayName: Terraform apply
            condition: and(succeeded(), eq(variables.isMain, true))
            inputs:
              command: apply
              workingDirectory: $(System.DefaultWorkingDirectory)/terraform
              environmentServiceName: $(serviceConnection)
              commandOptions: --auto-approve -var-file=../config/${{ environment.environment }}.tfvars -var environment=${{ environment.environment }}
